{% extends 'base.html' %}

{% block head %}
    <meta charset="UTF-8">
    <title>SW Room</title>
{% endblock %}

{% block Title_link_auth %}#{% endblock %}
{% block Title %}<span class="d-inline-block text-truncate" style="max-width: 750px;">{{room.name}}</span>{% endblock %}

{% block navbar_space_part_1 %}
<!--exclude space-->
{% endblock %}

{% block navbar_Rooms_button %}
<!--exclude DockingBay-->
{% endblock %}

{% block right_side_buttons %}
    <ul class="navbar-nav navbar-right">
        <li class="nav-item"><strong>GM:</strong> {{ gm_name }}</li>
        <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button"
               data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Navigate
            </a>
            <div class="dropdown-menu dropdown-menu-right">
              {% block dockingbay %}<a class="dropdown-item" href="{% url 'swdice:dockingbay' %}">Docking Bay</a>{% endblock %}
              {% block profile %}<a class="dropdown-item" href="{% url 'accounts:view_profile' %}">Profile</a>{% endblock %}
              {% block logout %}<div class="dropdown-divider"></div>
              <a class="dropdown-item" href="{% url 'accounts:logout' %}">Logout</a>{% endblock %}
            </div>
        </li>
    </ul>

{% endblock %}

{% block navbar_space_part_2 %}
<!--exclude space-->
{% endblock %}

{% block body %}
<div class="container-fluid">
<br>
    <div class="row">
        <div class="col-9">
            <table style="background-color: #f8f9fa; width:720px; margin: 0px 0px 5px 0px;">
                <tr>
                <form id="destiny" method="POST">
                {% csrf_token %}
                    <td style="width:12px;">
                        <button type="submit" class="btn btn-light btn-sm" name="add_dark">&#9650</button>
                        <br>
                        <button type="submit" class="btn btn-light btn-sm" name="rem_dark">&#9660</button>
                    </td>
                    <td style="width:33px;">
                        <button type="submit" class="btn btn-secondary outline-me" name="use_dark" id="use_dark">
                            Use<br>Dark
                        </button>
                    </td>
                    <td>
                        <span class="container-fluid" id="destiny_box">
                        {% if dark_pips == 0  and light_pips == 0 %}
                        There are no Destiny Points
                        {% endif %}
                        {% for i in dark_pips|get_range %}
                            <img src="/media/sw_images/Pips/black.png" width="40" title="Use Dark">
                        {% endfor %}
                        {% for i in light_pips|get_range %}
                            <img src="/media/sw_images/Pips/white.png" width="40" title="Use Light">
                        {% endfor %}
                        </span>
                    </td>
                    <td style="width:36px;">
                        <button type="submit" class="btn btn-outline-dark" name="use_light" id="use_light">
                            Use<br>Light
                        </button>
                    </td>
                    <td style="width:12px;">
                        <button type="submit" class="btn btn-light btn-sm" name="add_light">&#9650</button>
                        <br>
                        <button type="submit" class="btn btn-light btn-sm" name="rem_light">&#9660</button>
                    </td>
                </form>
                </tr>
            </table>
            <form id="dice" method="post" autocomplete="off">
                {% csrf_token %}
                <div class="container-fluid dice-container">
                    <img src="/media/sw_images/Dice/boost.png" width="40">{{ dice_form.num_boost_dice }}
                </div>
                <div class="container-fluid dice-container">
                    <img src="/media/sw_images/Dice/ability.png" width="40">{{ dice_form.num_ability_dice }}
                </div>
                <div class="container-fluid dice-container">
                    <img src="/media/sw_images/Dice/proficiency.png" width="40">{{ dice_form.num_proficiency_dice }}
                </div>
                <div class="container-fluid dice-container-long">
                    <img src="/media/sw_images/Dice/D100.png" width="80"><span class="big-font"> d</span>
                            {{ dice_form.numerical_dice_sides }}
                {{ dice_form.num_numerical_dice }}
                </div>

                <div class="container-fluid dice-container">
                    <button type="button" id="show_pips_button"
                            class="btn btn-outline-secondary btn-sm align-right"
                            onclick="showAutoPips()">
                        Extra Pips
                    </button>
                    <button type="button" id="hide_pips_button"
                            class="btn btn-outline-secondary btn-sm align-right"
                            onclick="hideAutoPips()" style="display:none">
                        Hide
                    </button>
                </div>
                <br class="clearBoth">
                <div class="container-fluid dice-container">
                    <img src="/media/sw_images/Dice/setback.png" width="40">{{ dice_form.num_setback_dice }}
                </div>
                <div class="container-fluid dice-container">
                    <img src="/media/sw_images/Dice/difficulty.png" width="40">{{ dice_form.num_difficulty_dice }}
                </div>
                <div class="container-fluid dice-container">
                    <img src="/media/sw_images/Dice/challenge.png" width="40">{{ dice_form.num_challenge_dice }}
                </div>
                <div class="container-fluid dice-container">
                    <img src="/media/sw_images/Dice/force.png" width="40">{{ dice_form.num_force_dice }}
                </div>
                <div class="container-fluid dice-container-long">
                    {{ dice_form.caption }}
                </div>

                <br class="clearBoth">

                <div id="hidden_fields" style="display:none">
                    <div class="container-fluid dice-container">
                        <img src="/media/sw_images/Faces/Add01.jpg" title='Automatic Threat'>
                        {{ dice_form.additional_triumph }}
                    </div>
                    <div class="container-fluid dice-container">
                        <img src="/media/sw_images/Faces/Add03.jpg" title='Automatic Success'>
                        {{ dice_form.additional_success }}
                    </div>
                    <div class="container-fluid dice-container">
                        <img src="/media/sw_images/Faces/Add05.jpg" title='Automatic Advantage'>
                        {{ dice_form.additional_advantage }}
                    </div>
                    <div class="container-fluid dice-container">
                        <img src="/media/sw_images/Faces/Add07.jpg" title='Automatic Light'>
                        {{ dice_form.additional_light_pips }}
                    </div>
                    <br class="clearBoth">
                    <div class="container-fluid dice-container">
                        <img src="/media/sw_images/Faces/Add02.jpg" title='Automatic Despair'>
                        {{ dice_form.additional_despair }}
                    </div>
                    <div class="container-fluid dice-container">
                        <img src="/media/sw_images/Faces/Add04.jpg" title='Automatic Failure'>
                        {{ dice_form.additional_failure }}
                    </div>
                    <div class="container-fluid dice-container">
                        <img src="/media/sw_images/Faces/Add06.jpg" title='Automatic Threat'>
                        {{ dice_form.additional_threat }}
                    </div>
                    <div class="container-fluid dice-container">
                        <img src="/media/sw_images/Faces/Add08.jpg" title='Automatic Dark'>
                        {{ dice_form.additional_dark_pips }}
                    </div>
                    <br class="clearBoth">
                </div>
                <button type="submit" class="btn btn-warning btn-lg top-margin" name="roll_dice">
                    <strong>Roll 'Em!</strong>
                </button>
            </form>
            <hr>
            <div class="container-fluid" id="action_log" style="padding:0">
                {% if action_log is empty %}
                    <p>This room has no actions.</p>
                {% else %}
                    {% for action in action_log %}
                        {% if action.is_just_caption %}
                            <p>
                            {% if action.image_url %}
                                <img src="{{ action.image_url }}" width="40">
                            {% endif %}
                            {{ action.caption }}
                            </p>
                            <hr>
                        {% else %}
                            <p>
                            {% if action.image_url %}
                                <img src="{{ action.image_url }}" width="40">
                            {% endif %}
                            <strong>Rolled: </strong>
                                <!--Individual Faces-->
                            {% for face in action.faces_summary|split_string %}
                                {% if face %}
                                <img src="/media/sw_images/Faces/{{face}}.jpg" title="{{face}}">
                                {% endif %}
                            {% endfor %}
                            {% if action.results_numerical %}
                                {% for number in action.results_numerical|split_string %}
                                    {% if number %}
                                        <mark>{{ number }}</mark>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                                <!--Summary-->
                                <br>
                                {% if action.faces_summary != "" %}
                                <strong>Results: </strong>
                                {% endif %}
                            {% if action.results_triumph > 0 %}
                                {% for i in action.results_triumph|get_range %}
                                <img src="/media/sw_images/Results/Tri01.jpg" title="{{action.results_triumph}} Triumph">
                                {% endfor %}
                            {% endif %}
                            {% if action.results_despair > 0 %}
                                {% for i in action.results_despair|get_range %}
                                <img src="/media/sw_images/Results/Des01.jpg" title="{{action.results_despair}} Despair">
                                {% endfor %}
                            {% endif %}
                            {% if action.results_success > 0 %}
                                {% for i in action.results_success|get_range %}
                                <img src="/media/sw_images/Results/Suc01.jpg" title="{{action.results_success}} Success">
                                {% endfor %}
                            {% endif %}
                            {% if action.results_failure > 0 %}
                                {% for i in action.results_failure|get_range %}
                                <img src="/media/sw_images/Results/Fai01.jpg" title="{{action.results_failure}} Failure">
                                {% endfor %}
                            {% endif %}
                            {% if action.results_advantage > 0 %}
                                {% for i in action.results_advantage|get_range %}
                                <img src="/media/sw_images/Results/Adv01.jpg" title="{{action.results_advantage}} Advantage">
                                {% endfor %}
                            {% endif %}
                            {% if action.results_threat > 0 %}
                                {% for i in action.results_threat|get_range %}
                                <img src="/media/sw_images/Results/Thr01.jpg" title="{{action.results_threat}} Threat">
                                {% endfor %}
                            {% endif %}
                            {% if action.results_light_pips > 0 %}
                                {% for i in action.results_light_pips|get_range %}
                                <img src="/media/sw_images/Results/Lig01.jpg" title="{{action.results_light_pips}} Light Pips">
                                {% endfor %}
                            {% endif %}
                            {% if action.results_dark_pips > 0 %}
                                {% for i in action.results_dark_pips|get_range %}
                                <img src="/media/sw_images/Results/Dar01.jpg" title="{{action.results_dark_pips}} Dark Pips">
                                {% endfor %}
                            {% endif %}
                            {% if action.results_cancel %}
                                <em>All dice have cancelled.</em>
                            {% endif %}

                            {% if action.caption %}
                                <br>
                                <strong>Caption: </strong>
                                {{ action.caption }}
                            {% endif %}
                            </p>
                        <hr>
                        {% endif %}
                    {% endfor %}
                {% endif %}
            </div>
        </div>
        <div class="col-3" style="padding:0">
            <span style="color:gray">You are signed in as: </span>
            <table>
                <tr>
                    <td>
                        {% if icon %}
                            <img src="{{ icon }}" width="80">
                        {% endif %}
                    </td>
                    <td>
                        <strong>{{ name_in_room }}</strong>
                    </td>
                </tr>
            </table>
            <h5>Chat</h5>
            <div class="container-fluid" id="chat_input" style="padding:0">
            <form method="post" autocomplete="off">
                {% csrf_token %}
                {{ form.chat_text }}
                <button type="submit" name="chat" class="btn btn-outline-dark btn-sm">
                    Add Chat
                </button>
            </form>
            </div>
            <hr>
            <div class="container-fluid" id="chat_log" style="padding:0">
            {% if chat_log is empty %}
                <p>This room has no chats</p>
            {% else %}
                <table>
                {% for chat in chat_log %}
                    <tr>
                        <td>
                        {% if chat.image_url %}
                            <img src="{{ chat.image_url }}" width="40">
                        {% endif %}
                        </td>
                        <td>
                        {{chat.chat_text}}
                        </td>
                    </tr>
                {% endfor %}
                </table>
            {% endif %}
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
        integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"
        integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<script>
function showAutoPips() {
    document.getElementById('hidden_fields').style.display='block'
    document.getElementById('show_pips_button').style.display='none'
    document.getElementById('hide_pips_button').style.display='block'
}
</script>
<script>
function hideAutoPips() {
    document.getElementById('hidden_fields').style.display='none'
    document.getElementById('show_pips_button').style.display='block'
    document.getElementById('hide_pips_button').style.display='none'
}
</script>
<script>
$(function() {
    function refresh_action_log(){
        var url_actions = document.URL + ' #action_log'
        $('#action_log').load(url_actions, function () {
            // When it loads, schedule the next request for 2s later
            setTimeout(refresh_action_log, 2000)
        });
    }
    function refresh_chat_log(){
        var url_actions = document.URL + ' #chat_log'
        $('#chat_log').load(url_actions, function () {
            // When it loads, schedule the next request for 2s later
            setTimeout(refresh_chat_log, 2000)
        });
    }
    function refresh_destiny_box() {
        var url_destiny = document.URL + ' #destiny_box'
        $('#destiny_box').load(url_destiny, function () {
            setTimeout(refresh_destiny_box, 2000)
        });
        // $('#use_dark').prop('disabled', false);
        // $('#use_light').prop('disabled', false);
    };

    refresh_action_log();
    refresh_chat_log();
    refresh_destiny_box();
})
</script>

{% endblock %}